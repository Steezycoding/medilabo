name: Java Module CI

on:
  pull_request:
    branches:
      - master
      - dev
    paths:
      - 'gateway/**'
      - 'patient-microservice/**'
      - '.github/workflows/maven.yml'

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - name: Gateway
            module: gateway
            unit_pattern: '*Tests'
            integration_pattern: '*IntegrationTest'
          - name: Patient microservice
            module: patient-microservice
            unit_pattern: '*Tests'
            integration_pattern: '*IntegrationTest'
    name: Run ${{ matrix.name }} pipeline
    steps:
      - name: Check out sources
        uses: actions/checkout@v4

      - name: Ensure Maven wrapper is executable
        run: chmod +x ${{ matrix.module }}/mvnw

      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          cache: maven

      - name: Compile module
        run: ./${{ matrix.module }}/mvnw -f ${{ matrix.module }}/pom.xml -B -DskipTests compile

      - name: Run unit tests
        run: ./${{ matrix.module }}/mvnw -f ${{ matrix.module }}/pom.xml -B "-Dtest=${{ matrix.unit_pattern }}" -DfailIfNoTests=false test

      - name: Run integration tests
        run: ./${{ matrix.module }}/mvnw -f ${{ matrix.module }}/pom.xml -B "-Dtest=${{ matrix.integration_pattern }}" -DfailIfNoTests=false test

      - name: Package module
        run: ./${{ matrix.module }}/mvnw -f ${{ matrix.module }}/pom.xml -B -DskipTests package

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.module }}-package
          path: /home/runner/work/medilabo/${{ matrix.module }}/target/*.jar
